import discord
import asyncio
import random
from rewards import *
from discord_components import DiscordComponents, Button, ButtonStyle
from config import DeleteMessage

async def search_player2(ctx, res, player1, bet, client, msg):
    DiscordComponents(client)
    emb = discord.Embed(title = f"–û—Ç–ª–∏—á–Ω–æ, —Ç–µ–ø–µ—Ä—å –æ–∂–∏–¥–∞–µ–º 2 –∏–≥—Ä–æ–∫–∞!–°—Ç–∞–≤–∫–∞ == {bet} hub bucks!", colour = discord.Colour.orange())
    emb.add_field(name = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏:", value = f"PLAYER1 - {player1}\n–ò–≥—Ä–∞ - RPS\n–†–µ–∂–∏–º - {res}")
    emb.set_thumbnail(url = "https://i.postimg.cc/JhhCy1SR/png-RPS.png")
    msg1 = await ctx.send(
                    embed = emb,
                    components = [
                        Button(style = ButtonStyle.red, label = "PLAYER2")
                    ]
          )
    try:
        response = await client.wait_for("button_click", timeout = 15)
    except asyncio.TimeoutError:
                    await msg_delete(ctx,msg)
                    await msg1.delete()
                    msg = await ctx.send(f"{ctx.author.mention} –ù–∏–∫—Ç–æ –Ω–µ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è —Å –≤–∞–º–∏ –∏–≥—Ä–∞—Ç—å.")
                    await asyncio.sleep(5)
                    msg.delete()
                    return
    while response.author == player1:
                    try:
                       response = await client.wait_for("button_click", timeout = 15)
                    except asyncio.TimeoutError:
                      await msg_delete(ctx,msg)
                      await msg1.delete()
                      msg = await ctx.send(f"{ctx.author.mention} –ù–∏–∫—Ç–æ –Ω–µ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è —Å –≤–∞–º–∏ –∏–≥—Ä–∞—Ç—å.")
                      await asyncio.sleep(5)
                      msg.delete()
    await msg1.delete()
    return response.author

async def msg_delete(ctx,msg):
    await ctx.message.delete()
    await msg.delete()

async def t_msg_delete(msg, msg1, msg2, msg3):
    await asyncio.sleep(5)
    await msg.delete()
    await msg1.delete()
    await msg2.delete()
    await msg3.delete()

async def info_RPS(ctx):
    emb = discord.Embed(title = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∏–≥—Ä–µ –∫–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞.", colour = discord.Colour.orange())
    emb.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
    emb.set_thumbnail(url = "https://i.postimg.cc/JhhCy1SR/png-RPS.png")
    emb.add_field(name = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:", value = "1.–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∏–≥—Ä–∞ '–∫–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞'.\n2.–ß—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–≤–æ–π –≤—ã–±–æ—Ä, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω—É—é –∫–Ω–æ–ø–∫—É –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º.\n3.–ï—Å—Ç—å 2 —Ä–µ–∂–∏–º–∞: –¥–æ 1 –ø–æ–±–µ–¥—ã –∏ –¥–æ 3 –ø–æ–±–µ–¥.\n3.–ù–∞ –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è –≤–∞–º –æ—Ç–≤–æ–¥–∏—Ç—Å—è –≤—Ä–µ–º—è(30 —Å–µ–∫—É–Ω–¥), –Ω–µ —É—Å–ø–µ–ª–∏, —Å—á–∏—Ç–∞–µ—Ç—Å—è, —á—Ç–æ –≤—ã —Å–¥–∞–ª–∏—Å—å.\
    \n4.–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª.\n5.üö´ –æ–∑–Ω–∞—á–∞–µ—Ç '—Å–¥–∞—Ç—å—Å—è'.\n6.–ó–∞ –∏–≥—Ä—É –¥–æ 3 –ø–æ–±–µ–¥ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –±–æ–ª—å—à–µ –æ–ø—ã—Ç–∞.")
    msg = await ctx.send(embed = emb)
    await DeleteMessage(ctx, msg, 10)

async def RPS_game(ctx,client, timeout, bet):
    DiscordComponents(client)
    emb = discord.Embed(title = "–ò–≥—Ä–∞ –≤ –∫–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞.", colour = discord.Colour.orange())
    emb.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
    emb.set_thumbnail(url = "https://i.postimg.cc/JhhCy1SR/png-RPS.png")
    emb.add_field(name = "–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Ä–µ–∂–∏–º–æ–≤:", value = "1 WIN\n3 WINS")
    msg = await ctx.send(
        embed = emb,
        components = [
        [Button(style = ButtonStyle.blue, label = "1 WIN"),
        Button(style = ButtonStyle.blue, label = "3 WINS"),
        Button(style = ButtonStyle.red, label = "–û—Ç–º–µ–Ω–∞")]
        ]
    )
    try:
           response = await client.wait_for("button_click", timeout = 10)
    except asyncio.TimeoutError:
                  await msg_delete(ctx,msg)
                  msg = await ctx.send(content = f"{ctx.author.mention} –ù–µ—Ç, —Ç–∞–∫ –Ω–µ—Ç.")
                  await asyncio.sleep(5)
                  await msg.delete()
                  return
    while response.author != ctx.author:
                  try:
                    response = await client.wait_for("button_click", timeout = 10)
                  except asyncio.TimeoutError:
                    await msg_delete(ctx,msg)
                    msg = await ctx.send(content = f"{ctx.author.mention} –ù–µ—Ç, —Ç–∞–∫ –Ω–µ—Ç.")
                    await asyncio.sleep(5)
                    await msg.delete()
                    return
    res = response.component.label
    player1 = response.author
    player2 = await search_player2(ctx, res, player1, bet, client, msg)
    await msg_delete(ctx,msg)
    msg = await ctx.send(f"{player1.mention} vs {player2.mention}!")
    queue = random.randint(1,2)
    if queue == 1:
            pass
    else:
            player1, player2 = player2, player1
    current_player = player1
    enemy = player2
    msg1 = await ctx.send(f"–°–µ–π—á–∞—Å —Ö–æ–¥–∏—Ç {current_player.mention}!")
    first_emb = discord.Embed(title = f"–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞({res})", colour = discord.Colour.orange())
    first_emb.set_footer(text = current_player.name, icon_url = current_player.avatar_url)
    first_emb.add_field(name = "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç:", value = "üíé  ‚úÇÔ∏è  üßª")
    msg2 = await ctx.send(embed = first_emb)   
    if res == "1 WIN":
       winner = "None"
       while winner == "None":
        for stage in range(2):
          new_emb = discord.Embed(title = "–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞(1 WIN)", colour = discord.Colour.orange())
          new_emb.set_footer(text = current_player.name, icon_url = current_player.avatar_url)
          new_emb.add_field(name = "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç:", value = "üíé  ‚úÇÔ∏è  üßª")
          await msg1.edit(f"–°–µ–π—á–∞—Å —Ö–æ–¥–∏—Ç {current_player.mention}!")
          await msg2.edit(
                embed = new_emb,
                components = [
                [Button(style = ButtonStyle.blue, label = "üíé"),
                 Button(style = ButtonStyle.blue, label = "‚úÇÔ∏è"),
                 Button(style = ButtonStyle.blue, label = "üßª"),
                 Button(style = ButtonStyle.red, label = "üö´")]
                ]
          )
          try:
             response = await client.wait_for("button_click", timeout = timeout)
          except asyncio.TimeoutError:
                msg3 = await ctx.send(f"{current_player.mention} —Å–¥–∞–ª—Å—è!\n{enemy.mention} WIN!")
                xp(ctx, current_player, 25)
                money(current_player, enemy, ctx)
                await t_msg_delete(msg, msg1, msg2, msg3)
                return
          while response.author != current_player:
               try:
                   response = await client.wait_for("button_click", timeout = timeout)
               except asyncio.TimeoutError:
                msg3 = await ctx.send(f"{current_player.mention} —Å–¥–∞–ª—Å—è!\n{enemy.mention} WIN!")
                xp(ctx, current_player, 25)
                money(current_player, enemy, ctx)
                await t_msg_delete(msg, msg1, msg2, msg3)
                return
          emoje = response.component.label
          if emoje == "üö´":
             msg3 = await ctx.send(f"{current_player.mention} —Å–¥–∞–ª—Å—è!\n{enemy.mention} WIN!")
             xp(ctx, current_player, 25)
             money(current_player, enemy, ctx)
             await t_msg_delete(msg, msg1, msg2, msg3)
             return
          else:
              if current_player == player1:
                  p1_emoje = emoje
              else:
                  p2_emoje = emoje
              current_player = player2
              enemy = player1
        winner = check_winner(player1, player2, p1_emoje, p2_emoje)
        if winner == "None":
            await msg.edit(f"{player1.mention} - {p1_emoje} and {player2.mention} - {p2_emoje}, –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –Ω–∏—á—å—ë–π, –ø–æ—ç—Ç–æ–º—É –æ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å –∑–∞–Ω–æ–≥–æ!")
            current_player = player1
            enemy = player2
       msg3 = await ctx.send(f"{player1.mention} - {p1_emoje} and {player2.mention} - {p2_emoje}\n{winner.mention} WIN!")
       xp(ctx, current_player, 50)
       money(current_player, enemy, ctx)
       await t_msg_delete(msg, msg1, msg2, msg3)
       return
    elif res == "3 WINS":
         p1_wins = 0
         p2_wins = 0
         for wins in range(3):
             winner = "None"
             while winner == "None":
                 for stage in range(2):
                     new_emb = discord.Embed(title = "–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞(3 WINS)", colour = discord.Colour.orange())
                     new_emb.set_footer(text = current_player.name, icon_url = current_player.avatar_url)
                     new_emb.add_field(name = "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç:", value = f"üíé  ‚úÇÔ∏è  üßª\n{player1} - {p1_wins} wins\n{player2} - {p2_wins} wins")
                     await msg1.edit(f"–°–µ–π—á–∞—Å —Ö–æ–¥–∏—Ç {current_player.mention}!")
                     await msg2.edit(
                        embed = new_emb,
                        components = [
                        [Button(style = ButtonStyle.blue, label = "üíé"),
                         Button(style = ButtonStyle.blue, label = "‚úÇÔ∏è"),
                         Button(style = ButtonStyle.blue, label = "üßª"),
                         Button(style = ButtonStyle.red, label = "üö´")]
                        ]
                     )
                     try:
                       response = await client.wait_for("button_click", timeout = timeout)
                     except asyncio.TimeoutError:
                       msg3 = await ctx.send(f"{current_player.mention} —Å–¥–∞–ª—Å—è!\n{enemy.mention} WIN!")
                       xp(ctx, current_player, 25)
                       money(current_player, enemy, ctx)
                       await t_msg_delete(msg, msg1, msg2, msg3)
                       return
                     while response.author != current_player:
                       try:
                          response = await client.wait_for("button_click", timeout = timeout)
                       except asyncio.TimeoutError:
                          msg3 = await ctx.send(f"{current_player.mention} —Å–¥–∞–ª—Å—è!\n{enemy.mention} WIN!")
                          xp(ctx, current_player, 25)
                          money(current_player, enemy, ctx)
                          await t_msg_delete(msg, msg1, msg2, msg3)
                          return
                     emoje = response.component.label
                     if emoje == "üö´":
                        msg3 = await ctx.send(f"{current_player.mention} —Å–¥–∞–ª—Å—è!\n{enemy.mention} WIN!")
                        xp(ctx, current_player, 25)
                        money(current_player, enemy, ctx)
                        await t_msg_delete(msg, msg1, msg2, msg3)
                        return
                     else:
                        if current_player == player1:
                          p1_emoje = emoje
                        else:
                          p2_emoje = emoje
                        current_player = player2
                        enemy = player1
                 winner = check_winner(player1, player2, p1_emoje, p2_emoje)
                 if winner == "None":
                    await msg.edit(f"{player1.mention} - {p1_emoje} and {player2.mention} - {p2_emoje}, {wins + 1} —Ä–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –Ω–∏—á—å—ë–π, –ø–æ—ç—Ç–æ–º—É –æ–Ω –Ω–∞—á–∞–ªc—è –∑–∞–Ω–æ–≥–æ!")
                    current_player = player1
                    enemy = player2
             await msg.edit(f"{player1.mention} - {p1_emoje} and {player2.mention} - {p2_emoje}, –≤ {wins + 1} —Ä–∞—É–Ω–¥–µ –ø–æ–±–µ–¥–∏–ª {winner.mention}!")
             if winner == player1:
                 p1_wins+=1
             else:
                 p2_wins+=1
             current_player = player1
             enemy = player2
         if p1_wins > p2_wins:
             winner = player1
             enemy = player2
         else:
             winner = player2
             enemy = player1
         msg3 = await ctx.send(f"{player1.mention} - {p1_wins} wins and {player2.mention} - {p2_wins} wins\n{winner.mention} WIN!")
         xp(ctx, winner, 60)
         money(winner, enemy, ctx)
         await t_msg_delete(msg, msg1, msg2, msg3)
         return
    else:
        msg = await ctx.send(content = f"{ctx.author.mention} –ù–µ—Ç, —Ç–∞–∫ –Ω–µ—Ç.")
        await asyncio.sleep(5)
        await msg.delete()
        return

def check_winner(player1, player2, p1_emoje, p2_emoje):
    if (p1_emoje == "‚úÇÔ∏è" and p2_emoje == "üßª") or (p1_emoje == "üíé" and p2_emoje == "‚úÇÔ∏è") or (p1_emoje == "üßª" and p2_emoje == "üíé"):
        return player1
    elif (p2_emoje == "‚úÇÔ∏è" and p1_emoje == "üßª") or (p2_emoje == "üíé" and p1_emoje == "‚úÇÔ∏è") or (p2_emoje == "üßª" and p1_emoje == "üíé"):
        return player2
    else:
        return "None"